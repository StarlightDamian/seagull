MACD的能量柱（Histogram）计算方法如下：

MACD柱状图 = MACD线 - 信号线

其中：
- MACD线 = 快速EMA - 慢速EMA
- 信号线 = MACD线的EMA

现在，让我们列出MACD在趋势和震荡期的一些常见交易原则，以及常用的默认参数：


| 市场条件 |                   常用参数                   |                        交易原则                         |
| :------: | :------------------------------------------: | :-----------------------------------------------------: |
|   趋势   |     快线: 12<br/>慢线: 26<br/>信号线: 9      |        1. MACD线从下方穿越零线上方买入，反之卖出        |
|          |                                              |           2. MACD线与信号线金叉买入，死叉卖出           |
|          |                                              |           3. 能量柱由负变正买入，由正变负卖出           |
|          |                                              |      4. MACD线与价格出现背离，可能预示趋势即将反转      |
|   震荡   |  快线: 5-8<br/>慢线: 13-17<br/>信号线: 4-6   | 1. 使用超买超卖区间，MACD线在高位死叉卖出，低位金叉买入 |
|          |                                              |      2. 结合其他震荡指标（如RSI）使用，提高准确性       |
|          |                                              |       3. 关注能量柱的收敛和发散，判断价格走势强弱       |
|   牛市   | 快线: 15-20<br/>慢线: 30-40<br/>信号线: 9-12 |            1. 使用较长的参数设置，减少假信号            |
|          |                                              |             2. 更多关注买入信号，持股不持币             |
|   熊市   |  快线: 8-10<br/>慢线: 17-23<br/>信号线: 7-9  |         1. 使用较短的参数设置，及时捕捉反弹机会         |
|          |                                              |             2. 更多关注卖出信号，持币不持股             |

补充说明：

1. 参数设置：MACD的默认参数（12,26,9）适用于大多数情况，但在不同的市场条件和交易周期下可能需要调整。

2. 趋势市场vs震荡市场：
   - 趋势市场中，MACD更有效，可以捕捉长期趋势。
   - 震荡市场中，MACD可能产生更多假信号，需要结合其他指标使用。

3. 牛市vs熊市：
   - 牛市中，可以使用较长的参数设置，减少噪音，抓住主要上涨趋势。
   - 熊市中，使用较短的参数可以更快地捕捉到可能的反弹机会。

4. 能量柱的使用：
   - 能量柱的收敛（柱状逐渐变短）可能预示趋势减弱。
   - 能量柱的发散（柱状逐渐变长）可能预示趋势增强。

5. 结合其他指标：
   - MACD通常与其他技术指标（如RSI、布林带）结合使用，以提高交易决策的准确性。

6. 时间框架：
   - MACD在不同的时间框架下表现不同，长期图表更适合捕捉主要趋势，短期图表更适合寻找入场点。

7. 背离：
   - 当价格创新高而MACD没有创新高，或价格创新低而MACD没有创新低时，可能出现背离，预示趋势可能反转。

记住，没有一个指标或策略是完美的。MACD应该作为整体交易策略的一部分，结合基本面分析和风险管理使用。根据具体的交易品种、市场条件和个人风险偏好，可能需要进行参数优化和策略调整。



## 针对macd，是否可以用macd两根线DIF、DEA的斜率作为交易信号。

是的，MACD 中的两根线 DIF（MACD 线）和 DEA（信号线）的斜率可以作为交易信号的依据。这种方法基于趋势的变化，更为敏感，并可能捕捉到更早的趋势反转信号。你可以通过计算这两根线的斜率（即差分）来生成交易信号，例如当斜率变正或变负时发出买入或卖出的信号。

具体可以通过以下方式实现：

1. **DIF 和 DEA 的斜率计算**：  
   斜率可以通过取差值计算，如 `DIF(t) - DIF(t-1)` 和 `DEA(t) - DEA(t-1)`。如果斜率为正，表明指标向上，可能是买入信号；如果斜率为负，表明指标向下，可能是卖出信号。

2. **使用斜率作为交易信号**：
   - 当 DIF 的斜率由负转正且 DEA 的斜率为正时，可以发出买入信号。
   - 当 DIF 的斜率由正转负且 DEA 的斜率为负时，可以发出卖出信号。

你可以在 `vectorbt` 中扩展当前的 `strategy` 方法来实现这个逻辑。以下是实现这种逻辑的示例代码：

```python
def strategy(self, subtable_df, data):
    window_fast, window_slow, window_signal = subtable_df[['window_fast', 'window_slow', 'window_signal']].values[0]

    # 计算 MACD
    macd = vbt.MACD.run(
        close=data,
        fast_window=window_fast,
        slow_window=window_slow,
        signal_window=window_signal,
        macd_ewm=False,
        signal_ewm=True,
        adjust=False
    )

    # 计算 DIF 和 DEA 的斜率
    dif_slope = macd.macd.diff()  # DIF 线的斜率
    dea_slope = macd.signal.diff()  # DEA 线的斜率

    # 生成交易信号
    entries = (dif_slope > 0) & (dea_slope > 0)  # 买入条件：DIF 和 DEA 的斜率都为正
    exits = (dif_slope < 0) & (dea_slope < 0)  # 卖出条件：DIF 和 DEA 的斜率都为负

    entries_exits_t = pd.concat([entries, exits], axis=1, keys=['entries', 'exits']).T
    return entries_exits_t
```

这样，你可以在当前 `MACD` 策略基础上，结合 DIF 和 DEA 的斜率，生成更为灵敏的交易信号。

你可以试试这个方法，看看在不同的市场条件下表现如何。